# 📋 问题库与解决方案 - Sonic PaperMod 主题

> 此文件记录项目遇到的所有问题、根本原因、采用的解决方案和经验教训。

## 使用说明

每个问题记录包含以下部分：

- **问题描述** - 具体现象和表现
- **根本原因分析** - 为什么会出现这个问题
- **解决方案** - 采取的具体解决步骤
- **关键修改** - 涉及的文件和改动位置
- **失败尝试** - 不行的方法（供参考，避免重复踩坑）
- **经验教训** - 从这个问题中学到什么，如何预防

---

## 问题 1: Hugo 模板基础理解

**发现时间**: 2026-02-20
**状态**: ✅ 已解决
**类型**: 基础知识

### 问题描述

开发者在修改模板时对以下概念不清楚：
- Hugo 模板的基本语法
- 模板中如何访问变量
- partial（模块）如何被调用
- 模板的条件语句和循环

### 根本原因分析

Sonic PaperMod 是 Hugo 主题，需要理解 Hugo 的模板系统才能正确修改。这是一个学习曲线问题。

### 解决方案

✅ 建议新开发者：
1. 阅读 [Hugo 官方文档 - Templates](https://gohugo.io/documentation/)
2. 学习基本语法：
   - `{{ .Variable }}` - 访问变量
   - `{{ range .Items }}...{{ end }}` - 循环
   - `{{ if .Condition }}...{{ end }}` - 条件判断
   - `{{ partial "module/header" . }}` - 调用模块

3. 查看项目中现有模板的用法示例

### 关键修改

- **文件**: 所有 `.tmpl` 文件
- **说明**: 遵循现有模板的结构和命名规范

### 失败尝试

❌ 没有深入学习 Hugo，直接修改导致语法错误
❌ 复制粘贴代码而不理解含义，导致逻辑错误

### 经验教训

**投入 30 分钟学习 Hugo 文档，可以节省数小时的调试时间。**

建议检查清单：
1. 阅读 [Hugo Templates 文档](https://gohugo.io/templates/)
2. 理解基本语法（变量、循环、条件）
3. 学会使用浏览器开发者工具查看生成的 HTML
4. 遇到问题时，逐步修改、逐步测试

---

## 问题 2: 响应式设计测试不完整

**发现时间**: 2026-02-20
**状态**: ⚠️ 需注意
**类型**: 测试方法

### 问题描述

修改样式或模板后，只在桌面浏览器测试，没有在手机和平板上测试，导致：
- 手机上显示混乱
- 某些元素在小屏幕上重叠或显示不全
- 深浅色模式在某些设备上显示不一致

### 根本原因分析

主题是响应式的，需要在多个设备尺寸上测试。仅在桌面上测试无法发现问题。

### 解决方案

✅ **完整的测试流程**：

1. **浏览器开发者工具测试**
   ```bash
   # 打开 F12 开发者工具
   # Ctrl+Shift+M 切换到设备模拟模式
   # 测试以下尺寸：
   # - 375px (iPhone SE)
   # - 414px (iPhone 12)
   # - 768px (iPad)
   # - 1024px (iPad Pro)
   # - 1280px (Desktop)
   # - 1920px (Full HD)
   ```

2. **实际设备测试**
   - 用真实手机打开网站（如果可能）
   - 检查深浅色模式在手机上是否正常

3. **检查清单**
   - [ ] 手机竖屏正常
   - [ ] 手机横屏正常
   - [ ] 平板显示正确
   - [ ] 桌面显示完美
   - [ ] 浅色模式显示正确
   - [ ] 深色模式显示正确

### 关键修改

- **文件**: `assets/main.css`
- **说明**: 所有修改都需要在多个断点测试

### 失败尝试

❌ 只在桌面浏览器测试，导致手机上显示问题
❌ 修改 CSS 后没有清除浏览器缓存，导致看到旧样式

### 经验教训

**修改前后的测试都很关键：**
1. 修改前：在多个尺寸上截图作为参考
2. 修改后：同样的尺寸上验证改动效果
3. 记录：在 `.ai/ISSUES_AND_SOLUTIONS.md` 中说明测试覆盖范围

---

## 问题 3: CSS 深浅色模式管理

**发现时间**: 2026-02-20
**状态**: ✅ 已解决
**类型**: 样式设计

### 问题描述

在修改颜色时，只改了浅色模式，导致深色模式显示不正常。或者在修改主题颜色时，没有同步更新两种模式下的所有相关颜色。

### 根本原因分析

主题使用 CSS 变量和 `@media (prefers-color-scheme: dark)` 以及 `body.dark-mode` 来管理颜色。如果某个地方只改了一种模式，会导致不一致。

### 解决方案

✅ **正确的颜色修改流程**：

1. **查找 CSS 变量定义**
   ```css
   /* assets/main.css 中的定义 */
   :root {
     --primary-color: #0066cc;  /* 浅色模式 */
     --text-color: #000000;
   }

   @media (prefers-color-scheme: dark) {
     :root {
       --primary-color: #0099ff;  /* 深色模式 */
       --text-color: #ffffff;
     }
   }

   body.dark-mode {
     --primary-color: #0099ff;  /* 用户手动切换 */
     --text-color: #ffffff;
   }
   ```

2. **修改颜色时**
   - 修改 `:root` 中的浅色模式颜色
   - 同时修改 `@media (prefers-color-scheme: dark)` 中的深色模式颜色
   - 同时修改 `body.dark-mode` 中的颜色（如果有）

3. **测试两种模式**
   ```bash
   # 测试系统深色模式：
   # Windows: 设置 → 系统 → 显示 → 深色
   # macOS: 系统偏好设置 → 通用 → 深色
   # Linux: 取决于桌面环境

   # 测试用户手动切换：
   # 点击网站上的深浅色模式切换按钮
   ```

### 关键修改

- **文件**: `assets/main.css`
- **关键位置**:
  - `:root { }` - 浅色模式的基础变量
  - `@media (prefers-color-scheme: dark) { }` - 系统深色模式
  - `body.dark-mode { }` - 用户手动切换的深色模式

### 失败尝试

❌ 只修改了一种模式，导致深色模式或浅色模式显示异常
❌ 修改了变量名但没有更新引用的地方

### 经验教训

**深浅色模式修改的三原则：**
1. **同步修改** - 同时修改两种模式的颜色
2. **全面测试** - 在两种模式下都要看一遍
3. **用搜索功能** - 用 Ctrl+F 搜索颜色值，确保修改了所有引用

---

## 问题 4: 模板变量大小写敏感

**发现时间**: 2026-02-20
**状态**: ⚠️ 常见问题
**类型**: 模板语法

### 问题描述

在模板中使用了错误的变量名称（大小写不对），导致变量无法访问，页面显示空白或数据丢失。

例如：
- `{{ .Title }}` vs `{{ .title }}`（错误）
- `{{ .Date }}` vs `{{ .date }}`（错误）
- `{{ .Categories }}` vs `{{ .categories }}`（错误）

### 根本原因分析

Hugo 模板中的变量名称**区分大小写**。Sonic 和 Hugo 约定使用大写字母（PascalCase）命名文章和页面的属性。

### 解决方案

✅ **正确的变量名称**：

常用文章变量（区分大小写）：
```hugo
{{ .Title }}       # 文章标题
{{ .Content }}        # 文章内容
{{ .Date }}           # 发布日期
{{ .Categories }}     # 分类列表
{{ .Tags }}           # 标签列表
{{ .Author }}         # 作者
{{ .Permalink }}      # 文章链接
{{ .Summary }}        # 文章摘要
{{ .Draft }}          # 是否草稿
```

**检查清单**：
1. 使用代码编辑器的自动完成功能
2. 参考现有模板中的变量用法
3. 查阅 Hugo 官方文档
4. 在浏览器控制台检查页面 HTML

### 关键修改

- **文件**: 所有 `.tmpl` 模板文件
- **说明**: 遵循现有代码的变量命名规范

### 失败尝试

❌ 使用小写或错误的变量名称
❌ 假设变量名称大小写无所谓

### 经验教训

**记住 Hugo 变量命名的 PascalCase 惯例，避免花费时间调试。**

建议：
1. 复制粘贴现有模板中的变量用法
2. 在修改前对比两个模板的变量名称
3. 使用编辑器的搜索替换检查一致性

---

## 问题 5: 文件路径和资源引用错误

**发现时间**: 2026-02-20
**状态**: ⚠️ 需注意
**类型**: 配置问题

### 问题描述

在模板或 CSS 中引用资源文件（如图片、字体、脚本）时，使用了错误的路径，导致资源无法加载。

例如：
- `url('/images/logo.png')` 应该是 `url('/assets/images/logo.png')`
- `{{ partial 'header.tmpl' }}` 应该是 `{{ partial "module/header.tmpl" }}`

### 根本原因分析

Hugo 有特定的路径规范和目录结构。不同类型的资源（partial、asset、static）有不同的引用方式。

### 解决方案

✅ **正确的路径和引用方式**：

1. **调用 partial（模块）**
   ```hugo
   {{ partial "module/header.tmpl" . }}
   {{ partial "module/footer.tmpl" . }}
   {{ partial "module/head.tmpl" . }}
   {{ partial "module/post-entry.tmpl" . }}
   ```

2. **引用资源文件**
   ```css
   /* CSS 中引用字体 */
   @font-face {
     font-family: 'CustomFont';
     src: url('/assets/fonts/custom.woff2');
   }

   /* CSS 中引用图片 */
   background-image: url('/assets/images/pattern.png');
   ```

3. **引用 static 文件**
   ```hugo
   <img src="/logo.png" alt="Logo">  /* 从 static/ 目录 */
   <a href="/docs/guide.pdf">Guide</a>  /* static/ 中的 PDF */
   ```

### 关键修改

- **文件**: 所有 `.tmpl` 文件和 `assets/main.css`
- **说明**: 确保路径正确指向目标文件

### 失败尝试

❌ 使用相对路径导致在某些页面上路径错误
❌ 忘记 `/assets/` 前缀
❌ 使用错误的分隔符（`\` 而不是 `/`）

### 经验教训

**定遵循项目的目录结构和路径规范：**
1. 查看项目的现有文件引用
2. 始终使用绝对路径（从 `/` 开始）
3. 使用浏览器开发者工具检查资源是否加载成功（F12 → Network 标签）
4. 对于不确定的路径，查阅 Hugo 官方文档

---

## 问题 6: 浏览器缓存导致样式不更新

**发现时间**: 2026-02-20
**状态**: ✅ 已解决
**类型**: 调试技巧

### 问题描述

修改了 CSS，但打开页面后样式没有改变。重新加载页面也没有帮助。开发者怀疑是自己的 CSS 没有生效。

### 根本原因分析

浏览器会缓存 CSS 文件以提高性能。修改 CSS 后，浏览器可能仍然使用缓存的旧版本。

### 解决方案

✅ **清除缓存的多种方法**：

1. **快速方法 - 硬刷新**
   ```
   Ctrl + Shift + R  （Windows/Linux）
   Cmd + Shift + R   （macOS）
   ```

2. **彻底清除方法**
   ```
   F12 打开开发者工具
   右键点击刷新按钮 → "清空缓存并硬刷新"
   ```

3. **禁用缓存（开发时）**
   ```
   F12 → Settings （齿轮图标）
   勾选 "Disable cache (while DevTools is open)"
   ```

4. **手动清除浏览器缓存**
   ```
   Ctrl + Shift + Del （打开缓存清除面板）
   选择时间范围 → "所有时间"
   勾选 "Cookie 和其他网站数据"
   勾选 "缓存的图片和文件"
   点击 "清除数据"
   ```

### 关键修改

- **无需修改代码**
- **说明**: 这是开发过程中常见的调试步骤

### 失败尝试

❌ 反复修改 CSS 后仍看不到效果，以为代码没有生效
❌ 浪费时间调试实际上已经修改成功的代码

### 经验教训

**缓存是双刃剑：**
1. **开发时** - 禁用缓存，确保看到最新的代码
2. **生产时** - 启用缓存，提高用户的加载速度
3. **测试时** - 使用硬刷新确保测试的是最新代码

快速检查清单：
- [ ] 修改 CSS 后立即硬刷新 (Ctrl+Shift+R)
- [ ] 如果还看不到，打开开发者工具查看网络请求
- [ ] 检查是否成功下载了新的 CSS 文件

---

## 问题 7: 模板注释被渲染

**发现时间**: 2026-02-20
**状态**: ⚠️ 需注意
**类型**: 模板语法

### 问题描述

在模板中添加了注释来解释代码，但这些注释出现在生成的 HTML 中，可能导致：
- HTML 文件大小增加
- 泄露内部开发细节
- 混淆访客

### 根本原因分析

不同的注释方式在 Hugo 中有不同的处理方式：
- HTML 注释 `<!-- -->` 会被保留在输出中
- Hugo 注释需要特殊的语法

### 解决方案

✅ **正确的注释方式**：

1. **Hugo 模板注释**（推荐）- 不会出现在 HTML 中
   ```hugo
   {{- /* 这是一个 Hugo 注释，不会出现在输出中 */ -}}
   ```

2. **条件注释**（如果需要在某些情况下显示）
   ```hugo
   {{- /* 只在开发时显示这个注释 */ -}}
   <!-- 这个注释会出现在 HTML 中 -->
   ```

3. **文档注释**（在模板顶部）
   ```hugo
   {{/*
   post-entry.tmpl
     显示单个文章的摘要卡片
     参数: .
     调用: {{ partial "module/post-entry" . }}
   */}}
   ```

### 关键修改

- **文件**: 所有 `.tmpl` 模板文件
- **说明**: 检查现有注释，用 Hugo 注释替换 HTML 注释

### 失败尝试

❌ 使用 HTML 注释 `<!-- -->` 导致注释出现在输出的 HTML 中
❌ 使用 `//` 单行注释（这在 Hugo 中不是注释）

### 经验教训

**使用正确的注释语法可以保持代码整洁和隐私。**

建议检查清单：
1. 搜索所有 `<!--` 注释
2. 考虑是否需要在输出中显示这些注释
3. 如果不需要，改用 Hugo 注释 `{{- /* */ -}}`
4. 为复杂的模块添加文档注释说明其用途

---

## 问题 8: 特异性问题（Specificity）

**发现时间**: 2026-02-20
**状态**: ✅ 已解决
**类型**: CSS 设计

### 问题描述

在 CSS 中添加了新的样式规则，但样式没有生效。即使使用了 `!important`，有时也无法解决。
例如：
```css
/* 这个规则可能被其他更具体的规则覆盖了 */
p { color: red; }

/* 这个规则会覆盖上面的 p 规则 */
article p { color: blue; }

/* 要覆盖它，需要 */
article section p { color: green; }  /* 更高的特异性 */
```

### 根本原因分析

CSS 的级联和继承规则遵循优先级系统。更具体的选择器会覆盖更通用的选择器。

### 解决方案

✅ **CSS 优先级从低到高**：

```
1. 浏览器默认样式（最低）
2. 外部样式表
3. 内部样式表
4. 内联样式
5. !important（最高，但不推荐）
```

✅ **选择器特异性从低到高**：

```css
/* 特异性最低 */
p { }                      /* 0,0,1 */
.class { }                        /* 0,1,0 */
#id { }             /* 1,0,0 */

/* 特异性较高 */
p.class { }                    /* 0,1,1 */
article > p.class { }              /* 0,1,2 */
#section > article p.class { }           /* 1,1,3 */
/* 特异性最高 */
p.class { color: red !important; }       /* 避免使用 !important */
```

✅ **修复样式不生效的步骤**：

1. **打开浏览器开发者工具**（F12）
2. **右键点击要调试的元素** → 选择"检查"
3. **查看应用到该元素的样式**
   - 生效的样式显示为正常文本
   - 被覆盖的样式显示为删除线
4. **找到被覆盖的规则**，记下它的特异性
5. **修改你的选择器**，使其特异性更高
6. **重新测试**

### 关键修改

- **文件**: `assets/main.css`
- **说明**: 遵循模块化 CSS 的组织方式，避免过度嵌套和过高特异性
### 失败尝试

❌ 使用 `!important` 来强制生效（导致难以维护）
❌ 增加选择器的嵌套深度（导致特异性爆炸）
❌ 添加新的相同特异性的规则（没有效果）

### 经验教训

**理解 CSS 特异性是掌握样式设计的关键。**

最佳实践：
1. **保持特异性低** - 使用简洁的选择器
2. **避免过度嵌套** - 最多 2-3 层嵌套
3. **极少使用 `!important`** - 仅在必要时使用
4. **使用浏览器开发者工具调试** - 可视化查看优先级
5. **模块化 CSS** - 使用 BEM 或其他命名规范

---

## 问题 9 修正: 仅删除 home info 默认值

**修正时间**: 2026-02-20
**状态**: ✅ 已修正
**类型**: 配置调整

### 修正说明

初始解决方案中删除了过多的默认值。经用户指正，只应删除 `home_info_title` 和 `home_info_content` 的默认值，其他字段（如 `copyright`）应保留默认值。

### 修正内容

✅ **保留的默认值**：
- `header_title`: "PaperMod" ✓
- `copyright`: 完整 HTML 内容 ✓

✅ **删除的默认值**：
- `home_info_title`: 改为 "" ✓
- `home_info_content`: 改为 "" ✓

### 修复后的行为

- ✅ 首页 home info 可以完全清空（无默认值，无留白）
- ✅ Footer copyright 保持默认显示（有默认值）
- ✅ 用户可自由控制 home info 的显示/隐藏
- ✅ Footer 始终显示（除非用户主动修改）

---

## 问题 10: 评论框架模板变量未被编译

**发现时间**: 2026-02-20
**状态**: ✅ 已解决
**类型**: 功能缺陷

### 问题描述

当在后台添加评论框架代码（如 Artalk）时，代码中的模板变量 `{{ .post.FullPath }}`、`{{ .post.Title }}`、`{{ .settings.header_title }}` 没有被编译，而是直接输出为文本。

导致 Artalk 收到错误消息：
```
Error: 未找到站点：`{{ .settings.header_title }}`，请在控制台创建站点
```

### 根本原因分析

在 `post.tmpl` 中，评论代码使用 `{{ noescape $commentCode }}` 直接输出，这只是将字符串原样输出，不进行模板编译。字符串中的 `{{ }}` 被当作文本处理。

### 解决方案

✅ **在输出前进行变量替换**：

```gotmpl
{{ $commentCode := .settings.comment_code | trim }}
{{ if $commentCode }}
{{ $processedCode := $commentCode }}
{{ $processedCode = (replace $processedCode "{{ .post.FullPath }}" .post.FullPath) }}
{{ $processedCode = (replace $processedCode "{{ .post.Title }}" .post.Title) }}
{{ $processedCode = (replace $processedCode "{{ .settings.header_title }}" .settings.header_title) }}
{{ noescape $processedCode }}
{{ end }}
```

使用 `replace` 函数将模板占位符替换为实际值。

### 关键修改

- **文件**: `post.tmpl` (第 52-58 行)
- **改动**：在 noescape 前对评论代码进行变量替换

### 失败尝试

❌ 直接使用 `{{ noescape }}` - 无法编译模板变量
❌ 尝试嵌套模板编译 - Go 模板引擎不支持动态模板

### 经验教训

**用户输入的代码片段不能直接使用 {{ noescape }}，需要预处理模板变量。**

最佳实践：
1. 对用户输入的代码进行字符串替换，替换已知的模板变量
2. 支持的变量：`.post.FullPath`、`.post.Title`、`.settings.header_title` 等
3. 记录文档中支持的变量列表
4. 考虑扩展支持更多变量

---

这个问题库将持续更新。每当遇到新的问题或解决方案时，请添加到这个文件中。

**贡献指南**：
1. 遇到问题时，记录问题现象
2. 分析根本原因
3. 找到解决方案
4. 添加到本文件中
5. 标记为 ✅（已解决）、⚠️（需注意）或 ❌（未解决）

---

**相关文件**：
- [IMPORTANT_NOTES.md](IMPORTANT_NOTES.md) - 常见错误和快速解决方案
- [PROJECT_OVERVIEW.md](PROJECT_OVERVIEW.md) - 项目结构和技术栈
- [MUST_READ_FIRST.md](MUST_READ_FIRST.md) - 强制规则和预防清单
